<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@400;700&family=Orbitron:wght@400;700&family=Cinzel:wght@700&family=VT323&display=swap" rel="stylesheet">
    <style>
        /* --- THEME DEFINITIONS --- */
        body.theme-classic {
            --main-bg: #f4f4f4; --text-color: #333333; --primary-color: #0D47A1; --secondary-color: #00796B;
            --accent-color: #D84315; --border-color: #cccccc; --danger-color: #c62828; --main-font: 'VT323', monospace;
            --button-radius: 0px; --special-bg: none; --card-bg: #ffffff;
        }
        body.theme-wonder-woman {
            --main-bg: #002266; --text-color: #FFD700; --primary-color: #FFD700; --secondary-color: #C00000;
            --accent-color: #FFD700; --border-color: #FFD700; --danger-color: #8B0000; --main-font: 'Cinzel', serif;
            --button-radius: 4px; --special-bg: none; --card-bg: rgba(255, 255, 255, 0.05);
        }
        body.theme-iron-man {
            --main-bg: #2E2E2E; --text-color: #00FFFF; --primary-color: #00FFFF; --secondary-color: #B22222;
            --accent-color: #00FFFF; --border-color: #00FFFF; --danger-color: #800000; --main-font: 'Orbitron', sans-serif;
            --button-radius: 2px; --special-bg: repeating-conic-gradient(from 0deg, #333 0% 25%, #2E2E2E 0% 50%) 50% 50% / 40px 40px;
            --card-bg: rgba(0, 0, 0, 0.2);
        }
        body.theme-batman {
            --main-bg: #121212; --text-color: #F5DE50; --primary-color: #F5DE50; --secondary-color: #708090;
            --accent-color: #F5DE50; --border-color: #F5DE50; --danger-color: #444; --main-font: 'Roboto Condensed', sans-serif;
            --button-radius: 0px; --special-bg: none; --card-bg: rgba(255, 255, 255, 0.05);
        }

        /* --- GENERAL STYLES --- */
        body {
            background-color: var(--main-bg); background-image: var(--special-bg); color: var(--text-color);
            font-family: var(--main-font); transition: background-color 0.5s;
        }
        .btn-theme {
            background-color: var(--primary-color); color: var(--main-bg); border-radius: var(--button-radius);
            transition: all 0.2s ease-in-out; border: 2px solid transparent; padding: 0.5rem 1rem;
        }
        .btn-theme:hover { filter: brightness(1.2); }
        .btn-outline {
            background-color: transparent; color: var(--primary-color); border: 2px solid var(--primary-color);
            border-radius: var(--button-radius); padding: 0.5rem 1rem;
        }
        .btn-outline:hover { background-color: var(--primary-color); color: var(--main-bg); }

        .checklist-item { border-left: 4px solid var(--primary-color); transition: all 0.2s ease-in-out; }
        .priority-flag { border-left-color: var(--danger-color) !important; background-color: oklab(from var(--danger-color) l a b / 20%);}
        .modal-content { color: var(--text-color); background-color: var(--main-bg); border: 2px solid var(--border-color); }
        .progress-bar-bg { background-color: var(--border-color); }
        .progress-bar-fill { background-color: var(--secondary-color); transition: width 0.5s ease-in-out; }
        #main-title { font-family: var(--main-font); }
        #main-title:focus { outline: 2px solid var(--accent-color); background-color: rgba(255,255,255,0.1); }
        .app-card { background-color: var(--card-bg); backdrop-filter: blur(4px); }
        .item-title:focus { outline: 1px dashed var(--accent-color); }
        
        /* --- FIREBASE UI STYLES --- */
        #login-screen {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }
    </style>
</head>
<body class="theme-classic">

    <div id="login-screen">
        <h1 class="text-4xl font-bold mb-4">Productivity Hub</h1>
        <button id="login-button" class="btn-theme text-2xl p-4">Login with Google</button>
    </div>

    <div id="app-container" class="min-h-screen hidden">
        <header class="p-4 flex justify-between items-center shadow-lg" style="background-color: var(--primary-color); color: var(--main-bg);">
            <h1 id="main-title" class="text-3xl font-bold cursor-pointer px-2" contenteditable="true">Productivity Hub</h1>
            <div class="flex items-center space-x-4">
                <div id="user-info" class="text-sm font-bold"></div>
                <div id="theme-switcher">
                    <button data-theme="classic" class="w-6 h-6 rounded-full bg-blue-800 border-2 border-transparent focus:outline-none ring-offset-2 ring-offset-gray-800 focus:ring-2 focus:ring-white" title="Classic"></button>
                    <button data-theme="wonder-woman" class="w-6 h-6 rounded-full bg-red-600 border-2 border-transparent focus:outline-none ring-offset-2 ring-offset-gray-800 focus:ring-2 focus:ring-white" title="Wonder Woman"></button>
                    <button data-theme="iron-man" class="w-6 h-6 rounded-full bg-cyan-400 border-2 border-transparent focus:outline-none ring-offset-2 ring-offset-gray-800 focus:ring-2 focus:ring-white" title="Iron Man"></button>
                    <button data-theme="batman" class="w-6 h-6 rounded-full bg-yellow-400 border-2 border-transparent focus:outline-none ring-offset-2 ring-offset-gray-800 focus:ring-2 focus:ring-white" title="Batman"></button>
                </div>
                <a href="focus.html" class="btn-theme flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-bullseye" viewBox="0 0 16 16"><path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/><path d="M8 13A5 5 0 1 1 8 3a5 5 0 0 1 0 10zm0 1A6 6 0 1 0 8 2a6 6 0 0 0 0 12z"/><path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/><path d="M9.5 8a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/></svg>
                    Focus
                </a>
                <button id="logout-button" class="btn-outline">Logout</button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
            <div class="lg:col-span-1 space-y-6">
                <div class="app-card p-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-2">Achievements</h2>
                    <div id="achievements-container" class="text-center"></div>
                </div>
                <div class="app-card p-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-2">Productivity Calendar</h2>
                    <div id="calendar-container"></div>
                </div>
                <div class="app-card p-4 rounded-lg shadow-md">
                    <h2 class="text-xl font-bold mb-2">Stopwatch</h2>
                    <div id="stopwatch" class="text-6xl font-mono text-center text-theme-primary mb-2">00:00:00</div>
                    <div class="flex justify-center space-x-4">
                        <button id="start-stop-btn" class="btn-theme w-24">Start</button>
                        <button id="reset-btn" class="btn-theme">Reset</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 app-card p-4 rounded-lg shadow-md">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 class="text-3xl font-bold">My Checklist</h2>
                    <div class="flex items-center gap-2">
                        <input type="text" id="search-input" placeholder="Search tasks..." class="p-2 border rounded-lg w-full md:w-auto text-black">
                    </div>
                </div>
                <div class="flex flex-wrap justify-end items-center mb-4 gap-2">
                    <button id="bulk-add-btn" class="btn-theme">Bulk Add</button>
                    <button id="add-subject-btn" class="btn-theme">Add Subject</button>
                </div>
                <div id="checklist-container" class="space-y-4"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-60 z-40"></div>
    <div id="bookmark-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-6 rounded-lg shadow-2xl z-50 w-11/12 max-w-md modal-content"></div>
    <div id="notes-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-6 rounded-lg shadow-2xl z-50 w-11/12 max-w-2xl modal-content flex flex-col max-h-[80vh]"></div>
    <div id="youtube-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black p-2 rounded-lg shadow-2xl z-50 w-11/12 max-w-4xl"></div>
    <div id="bulk-add-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-6 rounded-lg shadow-2xl z-50 w-11/12 max-w-2xl modal-content"></div>
    <div id="quotes-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 p-6 rounded-lg shadow-2xl z-50 w-11/12 max-w-2xl modal-content flex flex-col max-h-[80vh]"></div>

    <script type="module">
        // 1. Import Firebase Services
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // 2. Your Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAupZMTnCqwyz7WEGcA8pJS1r0nnYA6bMk",
            authDomain: "checkmeout-b57f2.firebaseapp.com",
            projectId: "checkmeout-b57f2",
            storageBucket: "checkmeout-b57f2.appspot.com",
            messagingSenderId: "199208936999",
            appId: "1:199208936999:web:56db3d05695e158d0bd002",
            measurementId: "G-S6T4G00G7F"
        };

        // 3. Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        let currentUser = null;

        // --- UI Elements ---
        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app-container');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const userInfoEl = document.getElementById('user-info');

        // --- App State & Data Handling ---
        const getDefaultState = () => ({
            hubTitle: 'Productivity Hub', currentTheme: 'classic',
            hubTitles: { classic: 'Productivity Hub', 'wonder-woman': 'Themysciran Scrolls', 'iron-man': 'Stark Industries R&D', batman: 'Gotham Case Files' },
            calendar: { displayDate: new Date(), bookmarks: {}, completionHeatmap: {} },
            checklist: [],
            stopwatch: { startTime: 0, elapsedTime: 0, intervalId: null },
            quotes: {
                classic: ["Well done is better than well said.", "The future depends on what you do today.", "Perseverance is failing 19 times and succeeding the 20th."],
                'wonder-woman': ["Only love can truly save the world.", "I will fight for those who cannot fight for themselves.", "Courage is not the absence of fear, but acting in spite of it."],
                'iron-man': ["Genius. Billionaire. Playboy. Philanthropist.", "Sometimes you‚Äôve gotta run before you can walk.", "If you‚Äôre nothing without this suit, then you shouldn‚Äôt have it."],
                batman: ["I wear a mask. And that mask, it‚Äôs not to hide who I am, but to create what I am.", "Endure. Master yourself. And become more than a man.", "Fear is a tool."]
            },
            mainQuotes: { classic: "Fortune favors the bold.", 'wonder-woman': "You are stronger than you believe.", 'iron-man': "Sometimes you gotta run before you can walk.", batman: "It‚Äôs not who I am underneath, but what I do that defines me." },
            achievements: { classic: { tasksCompleted: 0 }, 'wonder-woman': { tasksCompleted: 0 }, 'iron-man': { tasksCompleted: 0 }, batman: { tasksCompleted: 0 } }
        });

        let appState = getDefaultState();

        async function saveStateToFirebase() {
            if (!currentUser) return;
            try {
                const stateToSave = JSON.parse(JSON.stringify(appState));
                await setDoc(doc(db, "users", currentUser.uid), stateToSave);
                console.log("State saved to Firebase.");
            } catch (error) {
                console.error("Error saving state to Firebase: ", error);
            }
        }

        async function loadStateFromFirebase() {
            if (!currentUser) return getDefaultState();
            try {
                const docRef = doc(db, "users", currentUser.uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    console.log("Loaded state from Firebase.");
                    const loadedData = docSnap.data();
                    // FIX: Make sure loaded data is valid and merge with default state
                    // This prevents crashes if saved data is old or malformed.
                    const cleanState = {
                        ...getDefaultState(),
                        ...loadedData,
                        calendar: { ...getDefaultState().calendar, ...(loadedData.calendar || {}) },
                        stopwatch: { ...getDefaultState().stopwatch, ...(loadedData.stopwatch || {}) },
                        achievements: { ...getDefaultState().achievements, ...(loadedData.achievements || {}) },
                    };
                    if (cleanState.calendar.displayDate) {
                        cleanState.calendar.displayDate = new Date(cleanState.calendar.displayDate);
                    }
                    return cleanState;
                } else {
                    console.log("No existing data for user. Using default state.");
                    return getDefaultState();
                }
            } catch (error) {
                console.error("Error loading state from Firebase: ", error);
                alert("Could not load your data. Using a default state.");
                return getDefaultState();
            }
        }

        // Debounced save function to prevent too many writes to Firestore
        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        };
        const debouncedSave = debounce(saveStateToFirebase, 1500);

        // --- App Logic (Rendering, Modals, etc.) ---
        const mainTitleEl = document.getElementById('main-title');
        const achievementsContainer = document.getElementById('achievements-container');
        const calendarContainer = document.getElementById('calendar-container');
        const stopwatchEl = document.getElementById('stopwatch');
        const checklistContainer = document.getElementById('checklist-container');
        
        function renderAll() {
            try {
                document.body.className = `theme-${appState.currentTheme}`;
                mainTitleEl.textContent = appState.hubTitle;
                mainTitleEl.style.fontFamily = `var(--main-font)`;
                renderCalendar();
                renderChecklist();
                renderAchievements();
            } catch (error) {
                console.error("CRITICAL ERROR during renderAll:", error);
                alert("A critical error occurred while displaying your data. Please check the console for details.");
            }
        }
        
        // ... (All your other functions: renderAchievements, renderCalendar, openModal, findItem, etc.)
        // The content of these functions remains the same as your original full code.
        // For brevity, I'm not repeating them all here, but they are assumed to be present.
        // I will include a few key ones to show the integration.
        
        function findItem(path) {
            if (!path || !appState.checklist) return null;
            let current = { children: appState.checklist };
            for (const id of path) {
                if (!current || !current.children) return null;
                current = current.children.find(item => item.id === id);
            }
            return current;
        }

        function renderChecklist(searchTerm = '') {
            const scrollState = checklistContainer.scrollTop;
            checklistContainer.innerHTML = '';
            if (!appState.checklist) appState.checklist = [];
            let listToRender = appState.checklist;
            // ... filtering logic ...
            listToRender.forEach(subject => {
                checklistContainer.appendChild(createChecklistItem(subject, 0, [subject.id]));
            });
            // ... update progress bars ...
            checklistContainer.scrollTop = scrollState;
        }

        function createChecklistItem(item, level, path) {
            const itemEl = document.createElement('div');
            itemEl.className = `checklist-item p-2 rounded-lg ml-${level * 4} ${item.priority ? 'priority-flag' : ''}`;
            itemEl.dataset.path = JSON.stringify(path);
            const isParent = level < 3;
            let progressHTML = '';
            if (level === 0) {
                 progressHTML = `<div class="w-full progress-bar-bg rounded-full h-2 mt-2"><div class="progress-bar-fill h-2 rounded-full" style="width: 0%;"></div></div>`;
            }
            itemEl.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-2 flex-grow min-w-0">
                        ${isParent ? `<span class="toggle-collapse cursor-pointer">${item.collapsed ? '‚ñ∂Ô∏è' : 'üîΩ'}</span>` : ''}
                        <button class="edit-btn text-lg" title="Edit">‚úèÔ∏è</button>
                        <input type="checkbox" class="item-checkbox h-5 w-5 flex-shrink-0" ${item.completed ? 'checked' : ''}>
                        <span class="item-title flex-grow truncate">${item.title}</span>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0 ml-2">
                        <button class="notes-btn text-lg" title="Notes">üìù</button>
                        ${level === 3 ? `<button class="priority-btn text-lg" title="Toggle Priority">${item.priority ? 'üö©' : 'üè≥Ô∏è'}</button>` : ''}
                        ${isParent ? `<button class="add-child-btn text-lg" title="Add Sub-item">‚ûï</button>` : ''}
                        <button class="delete-btn text-lg" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
                ${progressHTML}
                <div class="children-container ${item.collapsed ? 'hidden' : ''} pt-2 space-y-2"></div>`;
            if (isParent && item.children) {
                const childrenContainer = itemEl.querySelector('.children-container');
                item.children.forEach(child => {
                    childrenContainer.appendChild(createChecklistItem(child, level + 1, [...path, child.id]));
                });
            }
            return itemEl;
        }

        function renderCalendar() {
            if(!appState.calendar) return;
            const { displayDate, bookmarks } = appState.calendar;
            // ... rest of the calendar rendering logic
        }
        function renderAchievements() {
            if (!appState.achievements || !appState.currentTheme) return;
            // ... rest of the achievements rendering logic
        }


        // --- Event Listeners ---
        document.getElementById('add-subject-btn').addEventListener('click', () => {
            if (!appState.checklist) appState.checklist = [];
            appState.checklist.push({ id: crypto.randomUUID(), title: 'New Subject', completed: false, collapsed: false, children: [] });
            renderChecklist();
            debouncedSave();
        });

        checklistContainer.addEventListener('click', e => {
            const target = e.target;
            const itemEl = target.closest('.checklist-item');
            if (!itemEl) return;
            // ... (rest of your complex click handler logic)
            // IMPORTANT: Ensure any state change calls debouncedSave()
            debouncedSave();
        });
        
        // ... (all other event listeners from your original app)
        // Ensure they call debouncedSave() after any state modification.

        // --- AUTHENTICATION (The Core Controller) ---
        loginButton.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => {
                console.error("Authentication Error:", error);
                alert(`Login Failed! Error: ${error.message}`);
            });
        });

        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in
                currentUser = user;
                console.log("onAuthStateChanged: User is logged in.", user);
                userInfoEl.textContent = `Hi, ${user.displayName.split(' ')[0]}`;

                // Load data and render the app
                appState = await loadStateFromFirebase();
                renderAll();

                // Show the main app
                appContainer.classList.remove('hidden');
                loginScreen.style.display = 'none';

            } else {
                // User is signed out
                currentUser = null;
                console.log("onAuthStateChanged: User is logged out.");
                
                // Reset state and show the login screen
                appState = getDefaultState();
                appContainer.classList.add('hidden');
                loginScreen.style.display = 'flex';
            }
        });

    </script>
</body>
</html>
