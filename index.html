<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Bangers&family=Cinzel:wght@700&family=Russo+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6;
            --secondary-color: #1e40af;
            --background-color: #f3f4f6;
            --text-color: #1f2937;
            --accent-color: #93c5fd;
            --font-family: 'Roboto', sans-serif;
        }

        .theme-classic {
            --primary-color: #4a5568;
            --secondary-color: #2d3748;
            --background-color: #f7fafc;
            --text-color: #1a202c;
            --accent-color: #a0aec0;
            --font-family: 'Roboto', sans-serif;
        }

        .theme-wonder-woman {
            --primary-color: #d90429;
            --secondary-color: #003049;
            --background-color: #fdfcdc;
            --text-color: #001d3d;
            --accent-color: #f77f00;
            --font-family: 'Cinzel', serif;
        }

        .theme-iron-man {
            --primary-color: #aa0000;
            --secondary-color: #f2b705;
            --background-color: #260101;
            --text-color: #f1f1f1;
            --accent-color: #d95d39;
            --font-family: 'Russo One', sans-serif;
        }

        .theme-batman {
            --primary-color: #1a1a1a;
            --secondary-color: #f2b705;
            --background-color: #0d0d0d;
            --text-color: #e5e5e5;
            --accent-color: #4d4d4d;
            --font-family: 'Bangers', cursive;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            font-family: var(--font-family);
        }

        .header {
            background-color: var(--primary-color);
            color: var(--background-color);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: var(--background-color);
        }
        .btn-primary:hover {
            background-color: var(--secondary-color);
        }

        .progress-bar-container {
            background-color: var(--accent-color);
        }
        .progress-bar {
            background-color: var(--secondary-color);
        }
        .checklist-item {
            border-left: 4px solid var(--primary-color);
        }
    </style>
</head>
<body class="theme-classic">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg text-center">
            <h1 class="text-3xl font-bold mb-4 text-gray-800">Productivity Hub</h1>
            <p class="text-gray-600 mb-6">Your personal space to get things done.</p>
            <button id="login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center mx-auto">
                <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/><path d="M1 1h22v22H1z" fill="none"/></svg>
                Sign in with Google
            </button>
        </div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden">
        <header class="header p-4 flex justify-between items-center shadow-md">
            <div>
                <h1 class="text-2xl font-bold">Productivity Hub</h1>
                <div class="flex items-center">
                    <span id="user-name" class="text-lg cursor-pointer"></span>
                    <input id="user-name-input" type="text" class="hidden bg-transparent border-b-2 border-white ml-2 focus:outline-none">
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="relative">
                    <button id="theme-switcher-btn" class="btn-primary py-2 px-4 rounded-lg">Change Theme</button>
                    <div id="theme-options" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-theme="theme-classic">Classic</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-theme="theme-wonder-woman">Wonder Woman</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-theme="theme-iron-man">Iron Man</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-theme="theme-batman">Batman</a>
                    </div>
                </div>
                <button id="logout-btn" class="btn-primary py-2 px-4 rounded-lg">Logout</button>
            </div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
            <!-- Left Column: Tools -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Stopwatch -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-2 text-gray-800">Stopwatch</h2>
                    <div id="stopwatch" class="text-4xl font-mono text-center text-gray-800 mb-4">00:00:00</div>
                    <div class="flex justify-center space-x-4">
                        <button id="start-stop-btn" class="btn-primary px-4 py-2 rounded-lg">Start</button>
                        <button id="reset-btn" class="btn-primary px-4 py-2 rounded-lg">Reset</button>
                    </div>
                </div>

                <!-- Calendar -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-2 text-gray-800">Calendar</h2>
                    <input type="date" id="calendar" class="w-full p-2 border rounded-lg">
                </div>
                
                <!-- Focus Mode -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-2 text-gray-800">Focus Mode</h2>
                    <a href="focus.html" class="block w-full text-center btn-primary py-2 px-4 rounded-lg">Enter Focus Zone</a>
                </div>

                <!-- Gamification -->
                <div class="bg-white p-4 rounded-lg shadow">
                    <h2 class="text-xl font-bold mb-2 text-gray-800">Rewards</h2>
                    <div id="badges-container" class="flex justify-around mb-4">
                        <!-- Badges will be injected here -->
                    </div>
                    <div id="quotes-container">
                        <h3 class="font-semibold text-gray-700">Unlocked Quotes:</h3>
                        <ul id="quotes-list" class="list-disc list-inside text-gray-600">
                           <!-- Quotes will be injected here -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Right Column: Checklist -->
            <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">My Checklist</h2>
                    <button id="add-subject-btn" class="btn-primary px-4 py-2 rounded-lg">Add Subject</button>
                </div>
                <div id="checklist-container" class="space-y-4">
                    <!-- Checklist items will be injected here -->
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAupZMTnCqwyz7WEGcA8pJS1r0nnYA6bMk",
            authDomain: "checkmeout-b57f2.firebaseapp.com",
            projectId: "checkmeout-b57f2",
            storageBucket: "checkmeout-b57f2.appspot.com",
            messagingSenderId: "199208936999",
            appId: "1:199208936999:web:56db3d05695e158d0bd002",
            measurementId: "G-S6T4G00G7F"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let userData = {};

        // UI Elements
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userNameEl = document.getElementById('user-name');
        const userNameInput = document.getElementById('user-name-input');
        const checklistContainer = document.getElementById('checklist-container');
        const addSubjectBtn = document.getElementById('add-subject-btn');
        const themeSwitcherBtn = document.getElementById('theme-switcher-btn');
        const themeOptions = document.getElementById('theme-options');

        // Themed Content
        const themes = {
            'theme-classic': {
                badges: { tier1: { name: 'Milestone', icon: '🏆' }, tier2: { name: 'Completionist', icon: '🏅' } },
                quotes: ["The secret of getting ahead is getting started.", "It does not matter how slowly you go as long as you do not stop.", "The future depends on what you do today."]
            },
            'theme-wonder-woman': {
                badges: { tier1: { name: 'Lasso of Truth', icon: '✨' }, tier2: { name: 'Amazonian Strength', icon: '🛡️' } },
                quotes: ["If the prospect of living in a world where trying to respect the basic rights of those around you... is a problem, then what sort of world do you want to live in?", "You are stronger than you believe. You have greater powers than you know.", "Go in peace. I will not harm you."]
            },
            'theme-iron-man': {
                badges: { tier1: { name: 'Arc Reactor', icon: '💡' }, tier2: { name: 'Proof of Heart', icon: '❤️' } },
                quotes: ["I am Iron Man.", "Sometimes you gotta run before you can walk.", "The truth is... I am Iron Man."]
            },
            'theme-batman': {
                badges: { tier1: { name: 'Batarang', icon: '🦇' }, tier2: { name: 'Symbol of Hope', icon: ' Gotham\'s Guardian' } },
                quotes: ["It's not who I am underneath, but what I do that defines me.", "Why do we fall? So we can learn to pick ourselves up.", "I'm Batman."]
            }
        };

        // --- AUTHENTICATION ---
        loginBtn.addEventListener('click', () => {
            signInWithPopup(auth, provider).catch(error => console.error("Authentication Error: ", error));
        });

        logoutBtn.addEventListener('click', () => {
            signOut(auth);
        });

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                await loadUserData();
                loginScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
            } else {
                currentUser = null;
                userData = {};
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
            }
        });

        // --- DATA MANAGEMENT ---
        async function loadUserData() {
            if (!currentUser) return;
            const docRef = doc(db, "user_data", currentUser.uid);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                userData = docSnap.data();
            } else {
                // Create new user data
                userData = {
                    displayName: currentUser.displayName || 'New User',
                    theme: 'theme-classic',
                    checklist: [],
                    badges: { tier1: 0, tier2: 0 },
                    completedTasks: 0,
                    calendarDate: ''
                };
                await setDoc(docRef, userData);
            }
            renderApp();
        }

        async function saveUserData() {
            if (!currentUser) return;
            const docRef = doc(db, "user_data", currentUser.uid);
            await setDoc(docRef, userData, { merge: true });
        }

        // --- APP RENDERING ---
        function renderApp() {
            document.body.className = userData.theme || 'theme-classic';
            userNameEl.textContent = userData.displayName;
            document.getElementById('calendar').value = userData.calendarDate || '';
            renderChecklist();
            renderGamification();
        }

        // --- THEME SWITCHER ---
        themeSwitcherBtn.addEventListener('click', () => {
            themeOptions.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!themeSwitcherBtn.contains(e.target) && !themeOptions.contains(e.target)) {
                themeOptions.classList.add('hidden');
            }
        });

        themeOptions.addEventListener('click', (e) => {
            if(e.target.tagName === 'A'){
                const newTheme = e.target.dataset.theme;
                userData.theme = newTheme;
                document.body.className = newTheme;
                themeOptions.classList.add('hidden');
                renderGamification();
                saveUserData();
            }
        });

        // --- USER NAME EDIT ---
        userNameEl.addEventListener('click', () => {
            userNameEl.classList.add('hidden');
            userNameInput.classList.remove('hidden');
            userNameInput.value = userNameEl.textContent;
            userNameInput.focus();
        });

        userNameInput.addEventListener('blur', async () => {
            const newName = userNameInput.value.trim();
            if (newName && newName !== userData.displayName) {
                userData.displayName = newName;
                userNameEl.textContent = newName;
                await saveUserData();
            }
            userNameEl.classList.remove('hidden');
            userNameInput.classList.add('hidden');
        });
        userNameInput.addEventListener('keydown', (e) => {
            if(e.key === 'Enter') userNameInput.blur();
        });

        // --- CHECKLIST LOGIC ---
        function renderChecklist() {
            checklistContainer.innerHTML = '';
            if (!userData.checklist) userData.checklist = [];
            userData.checklist.forEach((subject, sIdx) => {
                checklistContainer.appendChild(createChecklistItem(subject, [sIdx]));
            });
            updateAllProgressBars();
        }

        function createChecklistItem(item, path) {
            const div = document.createElement('div');
            div.className = 'checklist-item p-2 rounded-lg bg-gray-50 ml-4';
            if(path.length > 1) div.style.marginLeft = `${path.length * 1.5}rem`;

            const itemHeader = document.createElement('div');
            itemHeader.className = 'flex items-center justify-between';
            
            const leftSide = document.createElement('div');
            leftSide.className = 'flex items-center';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = item.completed;
            checkbox.className = 'mr-2 h-5 w-5';
            checkbox.addEventListener('change', () => toggleItemCompletion(path, checkbox.checked));

            const title = document.createElement('span');
            title.textContent = item.name;
            title.className = 'font-semibold cursor-pointer';
            title.addEventListener('click', () => {
                const newName = prompt('Enter new name:', item.name);
                if(newName) {
                    item.name = newName;
                    saveUserData().then(renderChecklist);
                }
            });

            const collapseIcon = document.createElement('span');
            collapseIcon.textContent = item.collapsed ? '▶️' : '🔽';
            collapseIcon.className = 'cursor-pointer mr-2';
            collapseIcon.addEventListener('click', () => {
                item.collapsed = !item.collapsed;
                saveUserData().then(renderChecklist);
            });

            leftSide.appendChild(collapseIcon);
            leftSide.appendChild(checkbox);
            leftSide.appendChild(title);
            
            const rightSide = document.createElement('div');
            rightSide.className = 'space-x-2';

            if (path.length < 4) { // Can add children up to Topic level
                const addButton = document.createElement('button');
                addButton.textContent = '+';
                addButton.className = 'bg-green-500 text-white w-6 h-6 rounded-full';
                addButton.addEventListener('click', () => addItem(path));
                rightSide.appendChild(addButton);
            }

            const deleteButton = document.createElement('button');
            deleteButton.textContent = '🗑️';
            deleteButton.className = 'bg-red-500 text-white w-6 h-6 rounded-full';
            deleteButton.addEventListener('click', () => deleteItem(path));
            rightSide.appendChild(deleteButton);
            
            itemHeader.appendChild(leftSide);
            itemHeader.appendChild(rightSide);
            div.appendChild(itemHeader);

            // Progress Bar for Subjects
            if (path.length === 1) {
                const progressContainer = document.createElement('div');
                progressContainer.className = 'progress-bar-container w-full rounded-full h-2.5 mt-2';
                const progressBar = document.createElement('div');
                progressBar.className = 'progress-bar h-2.5 rounded-full';
                progressBar.id = `progress-${path[0]}`;
                progressContainer.appendChild(progressBar);
                div.appendChild(progressContainer);
            }

            // Children
            if (!item.collapsed && item.children) {
                const childrenContainer = document.createElement('div');
                childrenContainer.className = 'mt-2 space-y-2';
                item.children.forEach((child, cIdx) => {
                    childrenContainer.appendChild(createChecklistItem(child, [...path, cIdx]));
                });
                div.appendChild(childrenContainer);
            }
            
            return div;
        }

        function getItemByPath(path) {
            let item = { children: userData.checklist };
            for(const index of path) {
                item = item.children[index];
            }
            return item;
        }

        function addItem(path) {
            const parent = getItemByPath(path);
            const name = prompt('Enter name for new item:');
            if (name) {
                if (!parent.children) parent.children = [];
                parent.children.push({ name, completed: false, collapsed: false, children: [] });
                parent.collapsed = false; // Ensure parent is expanded
                saveUserData().then(renderChecklist);
            }
        }
        addSubjectBtn.addEventListener('click', () => {
             const name = prompt('Enter name for new subject:');
             if (name) {
                if (!userData.checklist) userData.checklist = [];
                userData.checklist.push({ name, completed: false, collapsed: false, children: [] });
                saveUserData().then(renderChecklist);
            }
        });

        function deleteItem(path) {
            if (confirm('Are you sure you want to delete this item and all its sub-items?')) {
                let parent = { children: userData.checklist };
                for (let i = 0; i < path.length - 1; i++) {
                    parent = parent.children[path[i]];
                }
                const index = path[path.length - 1];
                parent.children.splice(index, 1);
                saveUserData().then(renderChecklist);
            }
        }

        function toggleItemCompletion(path, isCompleted) {
            const item = getItemByPath(path);
            let tasksChanged = 0;

            function setCompletion(currentItem, completed) {
                if(currentItem.completed !== completed) {
                    currentItem.completed = completed;
                    tasksChanged += completed ? 1 : -1;
                }
                if (currentItem.children) {
                    currentItem.children.forEach(child => setCompletion(child, completed));
                }
            }
            
            setCompletion(item, isCompleted);
            
            // Update parent completion status
            if(path.length > 1) {
                updateParentStatus(path.slice(0, -1));
            }
            
            userData.completedTasks = (userData.completedTasks || 0) + tasksChanged;
            checkBadges();
            saveUserData().then(renderChecklist);
        }

        function updateParentStatus(path) {
            if (path.length === 0) return;
            const parent = getItemByPath(path);
            const allChildrenCompleted = parent.children.every(child => child.completed);
            if (parent.completed !== allChildrenCompleted) {
                parent.completed = allChildrenCompleted;
                updateParentStatus(path.slice(0, -1));
            }
        }
        
        function updateAllProgressBars() {
            userData.checklist.forEach((subject, sIdx) => {
                updateProgressBar(sIdx);
            });
        }

        function updateProgressBar(subjectIndex) {
            const subject = userData.checklist[subjectIndex];
            const progressBar = document.getElementById(`progress-${subjectIndex}`);
            if (!progressBar) return;
            
            let totalTasks = 0;
            let completedTasks = 0;

            function countTasks(item) {
                if (!item.children || item.children.length === 0) { // Count only the lowest-level items
                    totalTasks++;
                    if (item.completed) completedTasks++;
                } else {
                    item.children.forEach(countTasks);
                }
            }

            countTasks(subject);
            const percentage = totalTasks > 0 ? (completedTasks / totalTasks) * 100 : (subject.completed ? 100 : 0);
            progressBar.style.width = `${percentage}%`;
        }


        // --- GAMIFICATION ---
        function renderGamification() {
            const themeConfig = themes[userData.theme] || themes['theme-classic'];
            const badgesContainer = document.getElementById('badges-container');
            const quotesList = document.getElementById('quotes-list');

            badgesContainer.innerHTML = `
                <div class="text-center">
                    <span class="text-3xl">${themeConfig.badges.tier1.icon}</span>
                    <p>${themeConfig.badges.tier1.name}: ${userData.badges.tier1}</p>
                </div>
                <div class="text-center">
                    <span class="text-3xl">${themeConfig.badges.tier2.icon}</span>
                    <p>${themeConfig.badges.tier2.name}: ${userData.badges.tier2}</p>
                </div>
            `;
            
            quotesList.innerHTML = '';
            const unlockedQuotesCount = userData.badges.tier1;
            for(let i = 0; i < unlockedQuotesCount && i < themeConfig.quotes.length; i++) {
                const li = document.createElement('li');
                li.textContent = themeConfig.quotes[i];
                quotesList.appendChild(li);
            }
        }

        function checkBadges() {
            // Tier 1 badge
            const newTier1Badges = Math.floor(userData.completedTasks / 10);
            if (newTier1Badges > userData.badges.tier1) {
                userData.badges.tier1 = newTier1Badges;
                alert(`New Badge Unlocked: ${themes[userData.theme].badges.tier1.name}! You also unlocked a new quote.`);
            }

            // Tier 2 badge
            let completedSubjects = 0;
            userData.checklist.forEach(subject => {
                if (subject.completed) completedSubjects++;
            });
            if (completedSubjects > userData.badges.tier2) {
                userData.badges.tier2 = completedSubjects;
                alert(`New Badge Unlocked: ${themes[userData.theme].badges.tier2.name}! You completed a whole subject!`);
            }
            renderGamification();
        }

        // --- STOPWATCH ---
        const stopwatchEl = document.getElementById('stopwatch');
        const startStopBtn = document.getElementById('start-stop-btn');
        const resetBtn = document.getElementById('reset-btn');
        let stopwatchInterval;
        let stopwatchTime = 0;
        let stopwatchRunning = false;

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600).toString().padStart(2, '0');
            const minutes = Math.floor((totalSeconds % 3600) / 60).toString().padStart(2, '0');
            const seconds = (totalSeconds % 60).toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        startStopBtn.addEventListener('click', () => {
            if (stopwatchRunning) {
                clearInterval(stopwatchInterval);
                startStopBtn.textContent = 'Start';
            } else {
                const startTime = Date.now() - stopwatchTime;
                stopwatchInterval = setInterval(() => {
                    stopwatchTime = Date.now() - startTime;
                    stopwatchEl.textContent = formatTime(stopwatchTime);
                }, 1000);
                startStopBtn.textContent = 'Stop';
            }
            stopwatchRunning = !stopwatchRunning;
        });

        resetBtn.addEventListener('click', () => {
            clearInterval(stopwatchInterval);
            stopwatchRunning = false;
            stopwatchTime = 0;
            stopwatchEl.textContent = '00:00:00';
            startStopBtn.textContent = 'Start';
        });
        
        // --- CALENDAR ---
        const calendarEl = document.getElementById('calendar');
        calendarEl.addEventListener('change', () => {
            userData.calendarDate = calendarEl.value;
            saveUserData();
        });

    </script>
</body>
</html>
