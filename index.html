<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productivity Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&family=Bangers&family=Cinzel:wght@700&family=Russo+One&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #3b82f6; --secondary-color: #1e40af; --background-color: #f3f4f6;
            --text-color: #1f2937; --accent-color: #93c5fd; --font-family: 'Roboto', sans-serif;
            --heatmap-1: #bee3f8; --heatmap-2: #63b3ed; --heatmap-3: #3182ce; --heatmap-4: #2c5282;
            --bookmark-1: #fed7d7; --bookmark-2: #fefcbf; --bookmark-3: #c6f6d5; --bookmark-4: #c3dafe;
        }
        .theme-classic {
            --primary-color: #4a5568; --secondary-color: #2d3748; --background-color: #f7fafc;
            --text-color: #1a202c; --accent-color: #a0aec0; --font-family: 'Roboto', sans-serif;
            --heatmap-1: #e2e8f0; --heatmap-2: #cbd5e0; --heatmap-3: #a0aec0; --heatmap-4: #718096;
            --bookmark-1: #fed7d7; --bookmark-2: #fefcbf; --bookmark-3: #c6f6d5; --bookmark-4: #c3dafe;
        }
        .theme-wonder-woman {
            --primary-color: #d90429; --secondary-color: #003049; --background-color: #fdfcdc;
            --text-color: #001d3d; --accent-color: #f77f00; --font-family: 'Cinzel', serif;
            --heatmap-1: #fca5a5; --heatmap-2: #f87171; --heatmap-3: #ef4444; --heatmap-4: #b91c1c;
            --bookmark-1: #93c5fd; --bookmark-2: #fcd34d; --bookmark-3: #ffffff; --bookmark-4: #fdba74;
        }
        .theme-iron-man {
            --primary-color: #aa0000; --secondary-color: #f2b705; --background-color: #260101;
            --text-color: #f1f1f1; --accent-color: #d95d39; --font-family: 'Russo One', sans-serif;
            --heatmap-1: #fca5a5; --heatmap-2: #ef4444; --heatmap-3: #b91c1c; --heatmap-4: #7f1d1d;
            --bookmark-1: #60a5fa; --bookmark-2: #fde047; --bookmark-3: #d1d5db; --bookmark-4: #fbbf24;
        }
        .theme-batman {
            --primary-color: #1a1a1a; --secondary-color: #f2b705; --background-color: #0d0d0d;
            --text-color: #e5e5e5; --accent-color: #4d4d4d; --font-family: 'Bangers', cursive;
            --heatmap-1: #6b7280; --heatmap-2: #4b5563; --heatmap-3: #374151; --heatmap-4: #1f2937;
            --bookmark-1: #fde047; --bookmark-2: #a3a3a3; --bookmark-3: #e5e5e5; --bookmark-4: #525252;
        }
        body { background-color: var(--background-color); color: var(--text-color); font-family: var(--font-family); }
        .header { background-color: var(--primary-color); color: var(--background-color); }
        .btn-primary { background-color: var(--primary-color); color: var(--background-color); }
        .btn-primary:hover { background-color: var(--secondary-color); }
        .progress-bar-container { background-color: var(--accent-color); }
        .progress-bar { background-color: var(--secondary-color); }
        .checklist-item { border-left: 4px solid var(--primary-color); }
        .priority-flagged { border-left: 4px solid var(--secondary-color) !important; background-color: var(--accent-color) !important; }
        .tooltip { visibility: hidden; }
        .has-tooltip:hover .tooltip { visibility: visible; }
    </style>
</head>
<body class="theme-classic">

    <!-- Login Screen -->
    <div id="login-screen" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-lg text-center"><h1 class="text-3xl font-bold mb-4 text-gray-800">Productivity Hub</h1><p class="text-gray-600 mb-6">Your personal space to get things done.</p><button id="login-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center mx-auto"><svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/><path d="M1 1h22v22H1z" fill="none"/></svg>Sign in with Google</button></div>
    </div>

    <!-- Main Application -->
    <div id="app" class="hidden">
        <header class="header p-4 flex justify-between items-center shadow-md">
            <div><h1 class="text-2xl font-bold">Productivity Hub</h1><div class="flex items-center"><span id="user-name" class="text-lg cursor-pointer"></span><input id="user-name-input" type="text" class="hidden bg-transparent border-b-2 border-white ml-2 focus:outline-none"></div></div>
            <div class="flex items-center space-x-4"><div class="relative"><button id="theme-switcher-btn" class="btn-primary py-2 px-4 rounded-lg">Change Theme</button><div id="theme-options" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20"><a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-theme="theme-classic">Classic</a><a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-theme="theme-wonder-woman">Wonder Woman</a><a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-theme="theme-iron-man">Iron Man</a><a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-theme="theme-batman">Batman</a></div></div><button id="logout-btn" class="btn-primary py-2 px-4 rounded-lg">Logout</button></div>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6 p-6">
            <!-- Left Column: Tools -->
            <div class="lg:col-span-1 space-y-6">
                <!-- Productivity Calendar -->
                <div class="bg-white p-4 rounded-lg shadow"><h2 class="text-xl font-bold mb-2 text-gray-800">Productivity Calendar</h2><div id="calendar-container"></div></div>
                <!-- Stopwatch -->
                <div class="bg-white p-4 rounded-lg shadow"><h2 class="text-xl font-bold mb-2 text-gray-800">Stopwatch</h2><div id="stopwatch" class="text-4xl font-mono text-center text-gray-800 mb-4">00:00:00</div><div class="flex justify-center space-x-4"><button id="start-stop-btn" class="btn-primary px-4 py-2 rounded-lg">Start</button><button id="reset-btn" class="btn-primary px-4 py-2 rounded-lg">Reset</button></div></div>
                <!-- Focus Mode -->
                <div class="bg-white p-4 rounded-lg shadow"><h2 class="text-xl font-bold mb-2 text-gray-800">Focus Mode</h2><a href="focus.html" class="block w-full text-center btn-primary py-2 px-4 rounded-lg">Enter Focus Zone</a></div>
                <!-- Gamification -->
                <div class="bg-white p-4 rounded-lg shadow"><h2 class="text-xl font-bold mb-2 text-gray-800">Rewards</h2><div id="badges-container" class="flex justify-around mb-4"></div><div id="quotes-container"><h3 class="font-semibold text-gray-700">Unlocked Quotes:</h3><ul id="quotes-list" class="list-disc list-inside text-gray-600"></ul></div></div>
            </div>

            <!-- Right Column: Checklist -->
            <div class="lg:col-span-2 bg-white p-4 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                    <h2 class="text-xl font-bold text-gray-800">My Checklist</h2>
                    <div class="flex items-center gap-2">
                        <input type="text" id="search-input" placeholder="Search tasks..." class="p-2 border rounded-lg text-gray-800"><button id="search-btn" class="btn-primary px-4 py-2 rounded-lg">Search</button>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="bulk-add-btn" class="btn-primary px-4 py-2 rounded-lg">Bulk Add</button>
                        <button id="add-subject-btn" class="btn-primary px-4 py-2 rounded-lg">Add Subject</button>
                    </div>
                </div>
                <div id="checklist-container" class="space-y-4"></div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30"></div>
    <!-- Bookmark Modal -->
    <div id="bookmark-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-lg z-40 w-96 text-gray-800"></div>
    <!-- Notes Modal -->
    <div id="notes-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-lg z-40 w-11/12 max-w-2xl text-gray-800"></div>
    <!-- YouTube Modal -->
    <div id="youtube-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black p-2 rounded-lg shadow-lg z-50"></div>
    <!-- Bulk Add Modal -->
    <div id="bulk-add-modal" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-lg z-40 w-11/12 max-w-2xl text-gray-800"></div>

    <script type="module">
        // Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAupZMTnCqwyz7WEGcA8pJS1r0nnYA6bMk",
            authDomain: "checkmeout-b57f2.firebaseapp.com",
            projectId: "checkmeout-b57f2",
            storageBucket: "checkmeout-b57f2.appspot.com",
            messagingSenderId: "199208936999",
            appId: "1:199208936999:web:56db3d05695e158d0bd002",
            measurementId: "G-S6T4G00G7F"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser = null;
        let userData = {};
        let currentCalendarDate = new Date();

        // UI Elements
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const userNameEl = document.getElementById('user-name');
        const userNameInput = document.getElementById('user-name-input');
        const checklistContainer = document.getElementById('checklist-container');
        const addSubjectBtn = document.getElementById('add-subject-btn');
        const themeSwitcherBtn = document.getElementById('theme-switcher-btn');
        const themeOptions = document.getElementById('theme-options');
        const calendarContainer = document.getElementById('calendar-container');
        const searchInput = document.getElementById('search-input');
        const searchBtn = document.getElementById('search-btn');
        const bulkAddBtn = document.getElementById('bulk-add-btn');

        // Themed Content
        const themes = {
            'theme-classic': {
                badges: { tier1: { name: 'Milestone', icon: '🏆' }, tier2: { name: 'Completionist', icon: '🏅' } },
                quotes: ["The secret of getting ahead is getting started.", "It does not matter how slowly you go as long as you do not stop.", "The future depends on what you do today."],
                bookmarkColors: {'#fed7d7':'Red', '#fefcbf':'Yellow', '#c6f6d5':'Green', '#c3dafe':'Blue'}
            },
            'theme-wonder-woman': {
                badges: { tier1: { name: 'Lasso of Truth', icon: '✨' }, tier2: { name: 'Amazonian Strength', icon: '🛡️' } },
                quotes: ["You are stronger than you believe.", "What one does when faced with the truth is more difficult than you'd think.", "Go in peace. I will not harm you."],
                bookmarkColors: {'#93c5fd':'Blue', '#fcd34d':'Gold', '#ffffff':'White', '#fdba74':'Orange'}
            },
            'theme-iron-man': {
                badges: { tier1: { name: 'Arc Reactor', icon: '💡' }, tier2: { name: 'Proof of Heart', icon: '❤️' } },
                quotes: ["I am Iron Man.", "Sometimes you gotta run before you can walk.", "An intelligent man once asked me if I knew what the square root of 841 was. I said 29."],
                bookmarkColors: {'#60a5fa':'Blue', '#fde047':'Gold', '#d1d5db':'Silver', '#fbbf24':'Orange'}
            },
            'theme-batman': {
                badges: { tier1: { name: 'Batarang', icon: '🦇' }, tier2: { name: 'Gotham\'s Guardian', icon: '🌃' } },
                quotes: ["It's not who I am underneath, but what I do that defines me.", "Why do we fall? So we can learn to pick ourselves up.", "I'm Batman."],
                bookmarkColors: {'#fde047':'Yellow', '#a3a3a3':'Grey', '#e5e5e5':'White', '#525252':'Dark Grey'}
            }
        };

        // --- AUTHENTICATION & DATA ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    currentUser = user;
                    await loadUserData();
                    loginScreen.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                } catch (error) {
                    console.error("Critical Error: Failed to load user data after login.", error);
                    alert("Could not load your data. This may be a Firestore security rule issue.");
                    signOut(auth);
                }
            } else {
                currentUser = null; userData = {};
                loginScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
            }
        });

        async function loadUserData() {
            if (!currentUser) return;
            const docRef = doc(db, "user_data", currentUser.uid);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                userData = docSnap.data();
            } else {
                userData = {
                    displayName: currentUser.displayName || 'New User', theme: 'theme-classic', checklist: [],
                    badges: { tier1: 0, tier2: 0 }, completedTasks: 0, completionDates: {}, calendarBookmarks: {}
                };
                await setDoc(docRef, userData);
            }
            // Ensure data structure is up to date
            userData.completionDates = userData.completionDates || {};
            userData.calendarBookmarks = userData.calendarBookmarks || {};
            renderApp();
        }

        async function saveUserData() {
            if (!currentUser) return;
            const docRef = doc(db, "user_data", currentUser.uid);
            await setDoc(docRef, userData, { merge: true });
        }
        
        loginBtn.addEventListener('click', () => signInWithPopup(auth, provider).catch(err => console.error("Auth Error", err)));
        logoutBtn.addEventListener('click', () => signOut(auth));

        // --- APP RENDERING ---
        function renderApp() {
            document.body.className = userData.theme || 'theme-classic';
            userNameEl.textContent = userData.displayName;
            renderCalendar();
            renderChecklist();
            renderGamification();
        }

        // --- CALENDAR ---
        function renderCalendar() {
            // Calendar logic will be extensive.
        }
        // Placeholder for the new calendar logic
        function renderCalendar() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();

            let calendarHTML = `
                <div class="flex justify-between items-center mb-2">
                    <button id="prev-month-btn" class="font-bold text-lg">‹</button>
                    <h3 class="font-bold">${currentCalendarDate.toLocaleString('default', { month: 'long' })} ${year}</h3>
                    <button id="next-month-btn" class="font-bold text-lg">›</button>
                </div>
                <div class="grid grid-cols-7 gap-1 text-center text-xs font-semibold">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-1 mt-2"></div>
            `;
            calendarContainer.innerHTML = calendarHTML;
            
            const grid = document.getElementById('calendar-grid');
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Add blank days for the start of the month
            for (let i = 0; i < firstDayOfMonth; i++) {
                grid.innerHTML += `<div></div>`;
            }

            // Add days of the month
            for (let i = 1; i <= daysInMonth; i++) {
                const date = new Date(year, month, i);
                const dateString = date.toISOString().split('T')[0];
                const dayEl = document.createElement('div');
                dayEl.textContent = i;
                dayEl.className = `relative p-2 rounded cursor-pointer text-center has-tooltip`;
                
                // Today's highlight
                if (date.getTime() === today.getTime()) {
                    dayEl.classList.add('bg-blue-500', 'text-white', 'font-bold');
                }
                
                // Heatmap
                const completedCount = userData.completionDates[dateString] || 0;
                if (completedCount > 0) {
                    let heatmapClass = '1';
                    if (completedCount >= 10) heatmapClass = '4';
                    else if (completedCount >= 8) heatmapClass = '3';
                    else if (completedCount >= 4) heatmapClass = '2';
                    dayEl.style.backgroundColor = `var(--heatmap-${heatmapClass})`;
                }

                // Bookmarks
                const bookmark = userData.calendarBookmarks[dateString];
                if (bookmark) {
                    dayEl.style.border = `2px solid ${bookmark.color}`;
                    dayEl.innerHTML += `<div class="tooltip absolute -top-8 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-xs rounded py-1 px-2 z-10 w-max">${bookmark.note}</div>`;
                }

                dayEl.addEventListener('click', () => openBookmarkModal(dateString));
                grid.appendChild(dayEl);
            }
            
            document.getElementById('prev-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderCalendar();
            });
            document.getElementById('next-month-btn').addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderCalendar();
            });
        }
        
        // --- MODALS ---
        const modalBackdrop = document.getElementById('modal-backdrop');
        function openModal(modal) { modalBackdrop.classList.remove('hidden'); modal.classList.remove('hidden'); }
        function closeModal(modal) { modalBackdrop.classList.add('hidden'); modal.classList.add('hidden'); }
        modalBackdrop.addEventListener('click', () => {
            document.querySelectorAll('.fixed.z-40, .fixed.z-50').forEach(m => m.classList.add('hidden'));
            modalBackdrop.classList.add('hidden');
        });

        function openBookmarkModal(dateString) {
            const modal = document.getElementById('bookmark-modal');
            const bookmark = userData.calendarBookmarks[dateString] || { note: '', color: '' };
            const themeColors = themes[userData.theme].bookmarkColors;
            
            let colorsHTML = '';
            for (const color in themeColors) {
                colorsHTML += `<button data-color="${color}" class="w-8 h-8 rounded-full" style="background-color: ${color}; border: ${bookmark.color === color ? '2px solid black' : '1px solid grey'}"></button>`;
            }

            modal.innerHTML = `
                <h3 class="font-bold text-lg mb-2">Bookmark for ${dateString}</h3>
                <textarea id="bookmark-note" class="w-full p-2 border rounded mb-2">${bookmark.note}</textarea>
                <div class="flex justify-around mb-4">${colorsHTML}</div>
                <div class="flex justify-end gap-2">
                    <button id="delete-bookmark" class="bg-red-500 text-white px-4 py-2 rounded">Delete</button>
                    <button id="save-bookmark" class="bg-blue-500 text-white px-4 py-2 rounded">Save</button>
                </div>`;
            
            openModal(modal);

            modal.querySelector('#save-bookmark').addEventListener('click', () => {
                const note = modal.querySelector('#bookmark-note').value;
                const selectedColor = modal.querySelector('button[data-color][style*="black"]')?.dataset.color;
                if (note && selectedColor) {
                    userData.calendarBookmarks[dateString] = { note, color: selectedColor };
                } else {
                    delete userData.calendarBookmarks[dateString];
                }
                saveUserData().then(() => {
                    renderCalendar();
                    closeModal(modal);
                });
            });
            modal.querySelector('#delete-bookmark').addEventListener('click', () => {
                delete userData.calendarBookmarks[dateString];
                saveUserData().then(() => {
                    renderCalendar();
                    closeModal(modal);
                });
            });
            modal.querySelectorAll('button[data-color]').forEach(btn => {
                btn.addEventListener('click', () => {
                    modal.querySelectorAll('button[data-color]').forEach(b => b.style.border = '1px solid grey');
                    btn.style.border = '2px solid black';
                });
            });
        }
        
        // --- GLOBAL SEARCH ---
        function filterChecklist(term) {
            if (!term) {
                renderChecklist(userData.checklist);
                return;
            }
            const lowerTerm = term.toLowerCase();
            const filtered = [];

            function search(items) {
                const results = [];
                for (const item of items) {
                    let match = item.name.toLowerCase().includes(lowerTerm);
                    let childrenResults = [];
                    if (item.children) {
                        childrenResults = search(item.children);
                    }
                    if (match || childrenResults.length > 0) {
                        results.push({ ...item, children: childrenResults, collapsed: false });
                    }
                }
                return results;
            }
            renderChecklist(search(userData.checklist));
        }
        searchBtn.addEventListener('click', () => filterChecklist(searchInput.value));
        searchInput.addEventListener('keyup', (e) => { if(e.key === 'Enter') filterChecklist(searchInput.value) });

        // --- CHECKLIST LOGIC (MODIFIED) ---
        function renderChecklist(data = userData.checklist) {
            checklistContainer.innerHTML = '';
            if (!data) return;
            data.forEach((subject, sIdx) => {
                checklistContainer.appendChild(createChecklistItem(subject, [sIdx]));
            });
            updateAllProgressBars();
        }

        function createChecklistItem(item, path) {
            const div = document.createElement('div');
            div.className = `checklist-item p-2 rounded-lg bg-gray-50 ml-4 ${item.priority ? 'priority-flagged' : ''}`;
            if(path.length > 1) div.style.marginLeft = `${path.length * 1.5}rem`;

            const itemHeader = document.createElement('div');
            itemHeader.className = 'flex items-center justify-between';
            
            const leftSide = document.createElement('div');
            leftSide.className = 'flex items-center';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.checked = item.completed;
            checkbox.className = 'mr-2 h-5 w-5 flex-shrink-0';
            checkbox.addEventListener('change', () => toggleItemCompletion(path, checkbox.checked));

            const title = document.createElement('span');
            title.textContent = item.name;
            title.className = 'font-semibold cursor-pointer';
            title.addEventListener('click', () => { /* edit logic */ });

            const collapseIcon = document.createElement('span');
            collapseIcon.textContent = item.collapsed ? '▶️' : '🔽';
            collapseIcon.className = 'cursor-pointer mr-2';
            collapseIcon.addEventListener('click', () => { /* collapse logic */ });

            leftSide.appendChild(collapseIcon);
            leftSide.appendChild(checkbox);
            leftSide.appendChild(title);
            
            const rightSide = document.createElement('div');
            rightSide.className = 'space-x-2 flex-shrink-0';
            
            // Add Priority Flag button for subtasks only
            if (path.length === 4) {
                 const priorityBtn = document.createElement('button');
                 priorityBtn.textContent = '🚩';
                 priorityBtn.title = 'Toggle Priority';
                 priorityBtn.className = `w-6 h-6 rounded-full ${item.priority ? 'bg-yellow-400' : 'bg-gray-300'}`;
                 priorityBtn.addEventListener('click', () => togglePriority(path));
                 rightSide.appendChild(priorityBtn);
            }
            
            // Notes button for all items
            const notesBtn = document.createElement('button');
            notesBtn.textContent = '📝';
            notesBtn.title = 'Notes & Attachments';
            notesBtn.className = 'w-6 h-6 rounded-full bg-gray-300';
            notesBtn.addEventListener('click', () => openNotesModal(path));
            rightSide.appendChild(notesBtn);


            if (path.length < 4) { /* Add button */ }
            /* Delete button */
            
            itemHeader.appendChild(leftSide);
            itemHeader.appendChild(rightSide);
            div.appendChild(itemHeader);

            if (path.length === 1) { /* Progress Bar */ }
            if (!item.collapsed && item.children) { /* Children */ }
            
            return div;
        }

        function toggleItemCompletion(path, isCompleted) {
            const item = getItemByPath(path);
            let tasksChanged = 0;
            let dateString = new Date().toISOString().split('T')[0];

            function setCompletion(currentItem, completed, currentPath) {
                if(currentItem.completed !== completed) {
                    currentItem.completed = completed;
                    tasksChanged += completed ? 1 : -1;
                    // Only track subtasks for heatmap
                    if (currentPath.length === 4) {
                        userData.completionDates[dateString] = (userData.completionDates[dateString] || 0) + (completed ? 1 : -1);
                        if(userData.completionDates[dateString] <= 0) delete userData.completionDates[dateString];
                    }
                }
                if (currentItem.children) {
                    currentItem.children.forEach((child, idx) => setCompletion(child, completed, [...currentPath, idx]));
                }
            }
            
            setCompletion(item, isCompleted, path);
            
            if(path.length > 1) updateParentStatus(path.slice(0, -1));
            
            userData.completedTasks = (userData.completedTasks || 0) + tasksChanged;
            checkBadges();
            saveUserData().then(() => {
                renderChecklist();
                renderCalendar();
            });
        }
        
        function togglePriority(path) {
            const item = getItemByPath(path);
            item.priority = !item.priority;
            saveUserData().then(renderChecklist);
        }

        function openNotesModal(path) {
            alert("Notes & Attachments feature is under construction!");
        }

        // --- BULK ADD ---
        bulkAddBtn.addEventListener('click', openBulkAddModal);

        function openBulkAddModal() {
            const modal = document.getElementById('bulk-add-modal');
            modal.innerHTML = `
                <h3 class="font-bold text-lg mb-2">Bulk Add From Text</h3>
                <p class="text-sm mb-2">Paste text with structure like "Subject: Name", "Section: Name", etc. Each on a new line.</p>
                <textarea id="bulk-add-textarea" class="w-full h-64 p-2 border rounded mb-2"></textarea>
                <div class="flex justify-end gap-2">
                    <button id="process-bulk-add" class="bg-blue-500 text-white px-4 py-2 rounded">Process</button>
                </div>`;
            openModal(modal);
            
            modal.querySelector('#process-bulk-add').addEventListener('click', () => {
                const text = modal.querySelector('#bulk-add-textarea').value;
                processBulkAdd(text);
                closeModal(modal);
            });
        }
        
        function processBulkAdd(text) {
            const lines = text.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return;

            let currentSubject, currentSection, currentTopic;

            lines.forEach(line => {
                const [type, ...nameParts] = line.split(':');
                const name = nameParts.join(':').trim();
                if (!name) return;

                const item = { name, completed: false, collapsed: false, children: [] };
                
                switch(type.trim().toLowerCase()) {
                    case 'subject':
                        userData.checklist.push(item);
                        currentSubject = item;
                        currentSection = null;
                        currentTopic = null;
                        break;
                    case 'section':
                        if (currentSubject) {
                            currentSubject.children.push(item);
                            currentSection = item;
                            currentTopic = null;
                        }
                        break;
                    case 'topic':
                        if (currentSection) {
                            currentSection.children.push(item);
                            currentTopic = item;
                        }
                        break;
                    case 'subtopic':
                        if (currentTopic) {
                            currentTopic.children.push(item);
                        }
                        break;
                }
            });
            saveUserData().then(renderChecklist);
        }

        // --- UTILITY & OTHER FUNCTIONS ---
        // Stubs for functions that need to be fully implemented or are placeholders
        function getItemByPath(path) {
            let item = { children: userData.checklist };
            for(const index of path) {
                if (!item || !item.children || !item.children[index]) return null;
                item = item.children[index];
            }
            return item;
        }
        function updateParentStatus(path) { /* ... existing logic ... */ }
        function updateAllProgressBars() { /* ... existing logic ... */ }
        function renderGamification() { /* ... existing logic ... */ }
        function checkBadges() { /* ... existing logic ... */ }
        // ... all other existing functions like stopwatch, user name edit, theme switcher etc.
    </script>
</body>
</html>
